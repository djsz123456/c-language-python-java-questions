<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>管理员后台 - 编程题库</title>
    <link rel="stylesheet" href="../css/style.css">
</head>
<body>
    <header>
        <div class="container">
            <h1>编程题库 - 管理员后台</h1>
        </div>
    </header>
    
    <nav>
        <div class="container">
            <ul>
                <li><a href="../index.html">返回题库首页</a></li>
                <li><a href="#" id="logoutBtn" class="hidden">退出登录</a></li>
            </ul>
        </div>
    </nav>
    
    <main>
        <div class="container">
            <!-- 登录区域 -->
            <section class="admin-login" id="loginSection">
                <h2>管理员登录</h2>
                <div id="loginMessage"></div>
                <form id="loginForm">
                    <div class="form-group">
                        <label for="password">管理员密码：</label>
                        <input type="password" id="password" name="password" required>
                    </div>
                    <button type="submit" class="btn-login">登录</button>
                </form>
            </section>
            
            <!-- 管理员控制台 -->
            <section class="admin-dashboard hidden" id="dashboardSection">
                <div id="message"></div>
                
                <h2>题库管理</h2>
                
                <div class="admin-actions">
                <button class="btn btn-primary" onclick="showAddForm()">添加新题目</button>
                <button class="btn btn-secondary" onclick="loadQuestions()">刷新题库</button>
                <button class="btn btn-secondary" onclick="exportQuestions()">导出数据</button>
                <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importQuestions(event)">
                <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()">导入数据</button>
            </div>
                
                <!-- 题目列表 -->
                <table class="questions-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>科目</th>
                            <th>题型</th>
                            <th>题目</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="questionsTable">
                        <!-- 题目将通过JavaScript动态加载 -->
                    </tbody>
                </table>
            </section>
            
            <!-- 添加/编辑题目表单 -->
            <section class="form-container hidden" id="formSection">
                <h2 id="formTitle">添加新题目</h2>
                <form id="questionForm">
                    <input type="hidden" id="questionId">
                    
                    <div class="form-group">
                        <label for="subject">科目：</label>
                        <select id="subject" required>
                            <option value="C++">C++</option>
                            <option value="Python">Python</option>
                            <option value="Java">Java</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="type">题型：</label>
                        <select id="type" required>
                            <option value="选择题">选择题</option>
                            <option value="填空题">填空题</option>
                            <option value="编程题">编程题</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="question">题目内容：</label>
                        <textarea id="question" required></textarea>
                    </div>
                    
                    <!-- 选择题选项 -->
                    <div id="optionsSection" class="form-group">
                        <label>选项（仅选择题）：</label>
                        <div class="option-inputs">
                            <input type="text" id="optionA" placeholder="选项 A">
                            <input type="text" id="optionB" placeholder="选项 B">
                            <input type="text" id="optionC" placeholder="选项 C">
                            <input type="text" id="optionD" placeholder="选项 D">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="answer">答案：</label>
                        <textarea id="answer" required></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="explanation">解析：</label>
                        <textarea id="explanation"></textarea>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="showDashboard()">取消</button>
                        <button type="submit" class="btn btn-primary">保存题目</button>
                    </div>
                </form>
            </section>
            
            <!-- 加载状态 -->
            <div class="loading" id="loading"></div>
        </div>
    </main>
    
    <script>
        // 配置信息 - 请根据实际情况修改
        const CONFIG = {
            owner: 'your-username',  // 替换为你的GitHub用户名
            repo: 'programming-exam-questions',  // 替换为你的仓库名
            token: 'your-github-pat',  // 替换为你的GitHub个人访问令牌
            adminPwd: 'admin123456',  // 替换为自定义管理员密码
            dataPath: 'data/questions.json'  // 题库数据文件路径
        };
        
        // 全局变量
        let questions = [];
        let isLoggedIn = false;
        let currentEditingId = null;
        
        // 页面加载完成后执行
        document.addEventListener('DOMContentLoaded', function() {
            checkLoginStatus();
            
            // 绑定登录表单事件
            document.getElementById('loginForm').addEventListener('submit', function(e) {
                e.preventDefault();
                login();
            });
            
            // 绑定题目表单事件
            document.getElementById('questionForm').addEventListener('submit', function(e) {
                e.preventDefault();
                saveQuestion();
            });
            
            // 绑定退出登录事件
            document.getElementById('logoutBtn').addEventListener('click', logout);
            
            // 绑定题型变化事件
            document.getElementById('type').addEventListener('change', function() {
                toggleOptionsSection();
            });
        });
        
        // 检查登录状态
        function checkLoginStatus() {
            isLoggedIn = localStorage.getItem('adminLoggedIn') === 'true';
            if (isLoggedIn) {
                showDashboard();
                loadQuestions();
            }
        }
        
        // 登录
        function login() {
            const password = document.getElementById('password').value;
            const messageElement = document.getElementById('loginMessage');
            
            if (password === CONFIG.adminPwd) {
                isLoggedIn = true;
                localStorage.setItem('adminLoggedIn', 'true');
                showDashboard();
                loadQuestions();
            } else {
                messageElement.innerHTML = '<div class="error-message">密码错误，请重试。</div>';
            }
        }
        
        // 退出登录
        function logout() {
            isLoggedIn = false;
            localStorage.removeItem('adminLoggedIn');
            showLogin();
        }
        
        // 显示登录界面
        function showLogin() {
            document.getElementById('loginSection').classList.remove('hidden');
            document.getElementById('dashboardSection').classList.add('hidden');
            document.getElementById('formSection').classList.add('hidden');
            document.getElementById('logoutBtn').classList.add('hidden');
            document.getElementById('loginForm').reset();
            document.getElementById('loginMessage').innerHTML = '';
        }
        
        // 显示控制台界面
        function showDashboard() {
            document.getElementById('loginSection').classList.add('hidden');
            document.getElementById('dashboardSection').classList.remove('hidden');
            document.getElementById('formSection').classList.add('hidden');
            document.getElementById('logoutBtn').classList.remove('hidden');
        }
        
        // 显示添加题目表单
        function showAddForm() {
            currentEditingId = null;
            document.getElementById('formTitle').textContent = '添加新题目';
            document.getElementById('questionForm').reset();
            document.getElementById('questionId').value = '';
            toggleOptionsSection(); // 初始显示选项区域
            document.getElementById('dashboardSection').classList.add('hidden');
            document.getElementById('formSection').classList.remove('hidden');
        }
        
        // 显示编辑题目表单
        function showEditForm(questionId) {
            currentEditingId = questionId;
            const question = questions.find(q => q.id === questionId);
            
            if (question) {
                document.getElementById('formTitle').textContent = '编辑题目';
                document.getElementById('questionId').value = question.id;
                document.getElementById('subject').value = question.subject;
                document.getElementById('type').value = question.type;
                document.getElementById('question').value = question.question;
                document.getElementById('answer').value = question.answer;
                document.getElementById('explanation').value = question.explanation || '';
                
                // 填充选项
                if (question.options) {
                    document.getElementById('optionA').value = question.options[0] || '';
                    document.getElementById('optionB').value = question.options[1] || '';
                    document.getElementById('optionC').value = question.options[2] || '';
                    document.getElementById('optionD').value = question.options[3] || '';
                }
                
                toggleOptionsSection();
                document.getElementById('dashboardSection').classList.add('hidden');
                document.getElementById('formSection').classList.remove('hidden');
            }
        }
        
        // 切换选项区域显示
        function toggleOptionsSection() {
            const type = document.getElementById('type').value;
            const optionsSection = document.getElementById('optionsSection');
            
            if (type === '选择题') {
                optionsSection.classList.remove('hidden');
            } else {
                optionsSection.classList.add('hidden');
            }
        }
        
        // 加载题库数据
        async function loadQuestions() {
            showLoading(true);
            
            try {
                // 首先从localStorage加载数据
                const savedQuestions = localStorage.getItem('programmingQuestions');
                
                if (savedQuestions) {
                    questions = JSON.parse(savedQuestions);
                } else {
                    // 如果localStorage没有数据，从本地JSON文件加载
                    const response = await fetch('../data/questions.json');
                    
                    if (!response.ok) {
                        throw new Error('Failed to load questions');
                    }
                    
                    questions = await response.json();
                }
                
                displayQuestions();
            } catch (error) {
                console.error('Error loading questions:', error);
                showMessage('加载题库失败，请检查网络连接或本地文件。', 'error');
            } finally {
                showLoading(false);
            }
        }
        
        // 显示题目列表
        function displayQuestions() {
            const tableBody = document.getElementById('questionsTable');
            
            if (questions.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5" style="text-align: center;">题库为空</td></tr>';
                return;
            }
            
            tableBody.innerHTML = questions.map(question => `
                <tr>
                    <td>${question.id}</td>
                    <td>${question.subject}</td>
                    <td>${question.type}</td>
                    <td>${question.question.substring(0, 50)}${question.question.length > 50 ? '...' : ''}</td>
                    <td>
                        <button class="btn btn-secondary" onclick="showEditForm(${question.id})">编辑</button>
                        <button class="btn btn-danger" onclick="deleteQuestion(${question.id})">删除</button>
                    </td>
                </tr>
            `).join('');
        }
        
        // 保存题目（添加或编辑）
        function saveQuestion() {
            showLoading(true);
            
            try {
                const questionData = {
                    subject: document.getElementById('subject').value,
                    type: document.getElementById('type').value,
                    question: document.getElementById('question').value,
                    answer: document.getElementById('answer').value,
                    explanation: document.getElementById('explanation').value
                };
                
                // 如果是选择题，添加选项
                if (questionData.type === '选择题') {
                    questionData.options = [
                        document.getElementById('optionA').value,
                        document.getElementById('optionB').value,
                        document.getElementById('optionC').value,
                        document.getElementById('optionD').value
                    ].filter(option => option.trim() !== '');
                } else {
                    // 填空题不需要options
                    questionData.options = undefined;
                }
                
                let updatedQuestions;
                
                if (currentEditingId) {
                    // 编辑现有题目
                    updatedQuestions = questions.map(q => 
                        q.id === currentEditingId ? { ...q, ...questionData } : q
                    );
                } else {
                    // 添加新题目
                    const newId = Math.max(...questions.map(q => q.id), 0) + 1;
                    questionData.id = newId;
                    updatedQuestions = [...questions, questionData];
                }
                
                // 保存到localStorage
                localStorage.setItem('programmingQuestions', JSON.stringify(updatedQuestions));
                
                // 更新本地数据
                questions = updatedQuestions;
                
                showMessage(currentEditingId ? '题目编辑成功！' : '题目添加成功！', 'success');
                showDashboard();
                displayQuestions();
            } catch (error) {
                console.error('Error saving question:', error);
                showMessage('保存题目失败，请重试。', 'error');
            } finally {
                showLoading(false);
            }
        }
        
        // 删除题目
        function deleteQuestion(questionId) {
            if (!confirm('确定要删除这个题目吗？')) {
                return;
            }
            
            showLoading(true);
            
            try {
                const updatedQuestions = questions.filter(q => q.id !== questionId);
                
                // 保存到localStorage
                localStorage.setItem('programmingQuestions', JSON.stringify(updatedQuestions));
                
                // 更新本地数据
                questions = updatedQuestions;
                
                showMessage('题目删除成功！', 'success');
                displayQuestions();
            } catch (error) {
                console.error('Error deleting question:', error);
                showMessage('删除题目失败，请重试。', 'error');
            } finally {
                showLoading(false);
            }
        }
        
        // 保存到本地JSON文件（导出功能）
        function saveToLocalFile() {
            try {
                const dataStr = JSON.stringify(questions, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                
                const downloadLink = document.createElement('a');
                downloadLink.href = URL.createObjectURL(dataBlob);
                downloadLink.download = 'questions.json';
                downloadLink.click();
                
                showMessage('题库数据已成功导出！', 'success');
            } catch (error) {
                console.error('Error exporting data:', error);
                showMessage('导出数据失败，请重试。', 'error');
            }
        }
        
        // 显示消息
        function showMessage(message, type) {
            const messageElement = document.getElementById('message');
            const className = type === 'success' ? 'success-message' : 'error-message';
            messageElement.innerHTML = `<div class="${className}">${message}</div>`;
            
            // 3秒后自动隐藏消息
            setTimeout(() => {
                messageElement.innerHTML = '';
            }, 3000);
        }
        
        // 显示加载状态
        function showLoading(show) {
            const loadingElement = document.getElementById('loading');
            if (show) {
                loadingElement.classList.remove('hidden');
            } else {
                loadingElement.classList.add('hidden');
            }
        }
    </script>
</body>
</html>
